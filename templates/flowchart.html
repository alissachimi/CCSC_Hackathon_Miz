<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectiveWizard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        .class-card {
            position: relative;
            margin-bottom: 5px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            cursor: grab;
        }
    </style>
</head>
<body>
    <div class="background-card">
        <h1 id="major-name">{{major}}</h1>
        <div class="container mt-5">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="year-title-card">FRESHMAN</div>
                    <div class="row">
                        <div class="col-md-6">Fall</div>
                        <div class="col-md-6">Spring</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="year-title-card">SOPHOMORE</div>
                    <div class="row">
                        <div class="col-md-6">Fall</div>
                        <div class="col-md-6">Spring</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="year-title-card">JUNIOR</div>
                    <div class="row">
                        <div class="col-md-6">Fall</div>
                        <div class="col-md-6">Spring</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="year-title-card">SENIOR</div>
                    <div class="row">
                        <div class="col-md-6">Fall</div>
                        <div class="col-md-6">Spring</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="freshman-fall" class="year-column class-grid">
                                <!-- dynamic allocation for recommended classes -->
                                {% set total_class_slots = 5 %}
                                {% set filled_class_slots = namespace(value=0) %}

                                <!-- update value compared on right side of equality operator below for each semester -->
                                {% for class in classes %}
                                    {% if filled_class_slots.value < total_class_slots %}
                                        {% if class[2] == 1 %}
                                            <div class="class-card filled" id="slot-0-{{ filled_class_slots.value }}">{{class[0]}}</div>
                                            {% set filled_class_slots.value=filled_class_slots.value+1 %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <!-- fill all remaining class slots -->
                                {% for i in range(filled_class_slots.value, total_class_slots) %}
                                <div class="class-card empty" id="slot-0-{{ i }}" onclick="cardClicked(this)"></div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="freshman-spring" class="year-column class-grid">
                                <!-- dynamic allocation for recommended classes -->
                                {% set filled_class_slots = namespace(value=0) %}

                                <!-- update value compared on right side of equality operator below for each semester -->
                                {% for class in classes %}
                                    {% if filled_class_slots.value < total_class_slots %}
                                        {% if class[2] == 2 %}
                                            <div class="class-card filled" id="slot-1-{{ filled_class_slots.value }}">{{class[0]}}</div>
                                            {% set filled_class_slots.value=filled_class_slots.value+1 %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <!-- fill all remaining class slots -->
                                {% for i in range(filled_class_slots.value, total_class_slots) %}
                                <div class="class-card empty" id="slot-1-{{ i }}" onclick="cardClicked(this)"></div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="sophomore-fall" class="year-column class-grid">
                                <!-- dynamic allocation for recommended classes -->
                                {% set filled_class_slots = namespace(value=0) %}

                                <!-- update value compared on right side of equality operator below for each semester -->
                                {% for class in classes %}
                                    {% if filled_class_slots.value < total_class_slots %}
                                        {% if class[2] == 3 %}
                                            <div class="class-card filled" id="slot-2-{{ filled_class_slots.value }}">{{class[0]}}</div>
                                            {% set filled_class_slots.value=filled_class_slots.value+1 %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <!-- fill all remaining class slots -->
                                {% for i in range(filled_class_slots.value, total_class_slots) %}
                                <div class="class-card empty" id="slot-2-{{ i }}" onclick="cardClicked(this)"></div>
                                {% endfor %}
                        </div>
                        </div>
                        <div class="col-md-6">
                            <div id="sophomore-spring" class="year-column class-grid">
                                <!-- dynamic allocation for recommended classes -->
                                {% set filled_class_slots = namespace(value=0) %}

                                <!-- update value compared on right side of equality operator below for each semester -->
                                {% for class in classes %}
                                    {% if filled_class_slots.value < total_class_slots %}
                                        {% if class[2] == 4 %}
                                            <div class="class-card filled" id="slot-3-{{ filled_class_slots.value }}">{{class[0]}}</div>
                                            {% set filled_class_slots.value=filled_class_slots.value+1 %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <!-- fill all remaining class slots -->
                                {% for i in range(filled_class_slots.value, total_class_slots) %}
                                <div class="class-card empty" id="slot-3-{{ i }}" onclick="cardClicked(this)"></div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="junior-fall" class="year-column class-grid">
                                <!-- dynamic allocation for recommended classes -->
                                {% set filled_class_slots = namespace(value=0) %}

                                <!-- update value compared on right side of equality operator below for each semester -->
                                {% for class in classes %}
                                    {% if filled_class_slots.value < total_class_slots %}
                                        {% if class[2] == 5 %}
                                            <div class="class-card filled" id="slot-4-{{ filled_class_slots.value }}">{{class[0]}}</div>
                                            {% set filled_class_slots.value=filled_class_slots.value+1 %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <!-- fill all remaining class slots -->
                                {% for i in range(filled_class_slots.value, total_class_slots) %}
                                <div class="class-card empty" id="slot-4-{{ i }}" onclick="cardClicked(this)"></div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="junior-spring" class="year-column class-grid">
                                <!-- dynamic allocation for recommended classes -->
                                {% set filled_class_slots = namespace(value=0) %}

                                <!-- update value compared on right side of equality operator below for each semester -->
                                {% for class in classes %}
                                    {% if filled_class_slots.value < total_class_slots %}
                                        {% if class[2] == 6 %}
                                            <div class="class-card filled" id="slot-5-{{ filled_class_slots.value }}">{{class[0]}}</div>
                                            {% set filled_class_slots.value=filled_class_slots.value+1 %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <!-- fill all remaining class slots -->
                                {% for i in range(filled_class_slots.value, total_class_slots) %}
                                <div class="class-card empty" id="slot-5-{{ i }}" onclick="cardClicked(this)"></div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="senior-fall" class="year-column class-grid">
                                <!-- dynamic allocation for recommended classes -->
                                {% set filled_class_slots = namespace(value=0) %}

                                <!-- update value compared on right side of equality operator below for each semester -->
                                {% for class in classes %}
                                    {% if filled_class_slots.value < total_class_slots %}
                                        {% if class[2] == 7 %}
                                            <div class="class-card filled" id="slot-6-{{ filled_class_slots.value }}">{{class[0]}}</div>
                                            {% set filled_class_slots.value=filled_class_slots.value+1 %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <!-- fill all remaining class slots -->
                                {% for i in range(filled_class_slots.value, total_class_slots) %}
                                <div class="class-card empty" id="slot-6-{{ i }}" onclick="cardClicked(this)"></div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="senior-spring" class="year-column class-grid">
                                <!-- dynamic allocation for recommended classes -->
                                {% set filled_class_slots = namespace(value=0) %}

                                <!-- update value compared on right side of equality operator below for each semester -->
                                {% for class in classes %}
                                    {% if filled_class_slots.value < total_class_slots %}
                                        {% if class[2] == 8 %}
                                            <div class="class-card filled" id="slot-7-{{ filled_class_slots.value }}">{{class[0]}}</div>
                                            {% set filled_class_slots.value=filled_class_slots.value+1 %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <!-- fill all remaining class slots -->
                                {% for i in range(filled_class_slots.value, total_class_slots) %}
                                <div class="class-card empty" id="slot-7-{{ i }}" onclick="cardClicked(this)"></div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="list-card">
                                <div class="list-items-container" id="electiveList">
                                    <!-- Elective items will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6" id="electiveDetails">
                            <div class="info-card">
                                <h4 id="detailTitle"></h4>
                                <div id="detailDescription"></div>
                                <div id="detailAvailability"></div>
                                <div id="detailMinor"></div>
                                <p><strong>Prerequisite:</strong> <span id="detailPrereq"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="minor-button" id="selectCourseButton">Select Course</button>
                </div>
            </div>
        </div>
    </div>

    <script>

        // Initialize Sortable for all year columns
        document.querySelectorAll('.class-grid').forEach(column => {
            new Sortable(column, {
                group: 'shared', // Allow dragging between lists
                animation: 150,
                ghostClass: 'sortable-ghost', // Class for the ghost element
                onEnd: function (evt) {
                    // Ensure cards can't be dragged out of their columns
                    if (!evt.to.classList.contains('class-grid')) {
                        evt.from.appendChild(evt.item); // Revert the drag
                    }
                }
            });
        });

        let selectedCard = null; // Variable to store the clicked card

        function cardClicked(card) {
            selectedCard = card; // Store the clicked card
            $('#myModal').modal('show');
        }

        $('#selectCourseButton').on('click', function () {
            if (selectedCard && selectedCard.classList.contains('empty')) {
                const selectedItem = items.find(item => item.id === $('#detailTitle').data('id'));

                if (selectedItem) {
                    // Update the card content
                    selectedCard.innerHTML = `
                        ${selectedItem.id} 
                    `;

                    // Change the card class from 'empty' to 'filled'
                    selectedCard.classList.remove('empty');
                    selectedCard.classList.add('filled');

                    // Optionally, disable further clicks on the card
                    selectedCard.onclick = null;

                    // Close the modal
                    $('#myModal').modal('hide');
                }
            }
        });

        function loadItems(){
            let major = "Bachelor of Science - " + document.getElementById("major-name").innerHTML;
            return fetch(`/get_electives?major=${encodeURIComponent(major)}`)
                .then(response => response.json())
                .then(data => {
                    items.length = 0; // Clear array
                    items.push(...data);
                    console.log("Items loaded:", items);
                })
                .catch(error => console.error("Error fetching courses:", error));
        }

        let items = [];

        function loadElectives() {
            const electiveList = $('#electiveList');
            electiveList.empty();

            items.forEach(item => {
                const red = Math.round(200 + (55 * (1 - item.availability)));
                const green = Math.round(200 + (55 * item.availability));
                const color = `rgba(${red}, ${green}, 200, 0.5)`;
                const glowColor = `rgba(${red}, ${green}, 200)`; // Slightly more opaque for the glow

                const card = `
                    <div class="list-item" data-id="${item.id}" style="box-shadow: 0 0 5px 2px ${glowColor};">
                        <h5>${item.id}</h5>
                        <h4>${item.name}</h4>
                    </div>
                `;
                electiveList.append(card);
            });
        }

        function showElectiveDetails(id) {
            const item = items.find(i => i.id === id);
            if (item) {
                // Update title
                $('#detailTitle').text(item.name).data('id', item.id);

                // Update description
                $('#detailDescription').html(`
                    <div class="description-card">
                        <p>${item.description}</p>
                    </div>
                `);

                // Update availability with dynamic color
                const availabilityPercent = Math.round(item.availability * 100);
                const progressColor = availabilityPercent < 50 ? '#ff4444' : availabilityPercent < 75 ? '#ffbb33' : '#4caf50';
                $('#detailAvailability').html(`
                    <div class="availability-container">
                        <div class="availability-label">Availability: ${availabilityPercent}%</div>
                        <div class="availability-bar">
                            <div class="availability-progress" style="width: ${availabilityPercent}%; background-color: ${progressColor}"></div>
                        </div>
                    </div>
                `);

                // Update minors list as buttons with popups
                const minors = item.minor === 'Yes' ? ['Computer Science', 'Data Science', 'Cybersecurity'] : ['None'];
                const minorsHtml = minors.map(minor => `
                    <button class="minor-button" data-minor="${minor}">${minor}</button>
                `).join('');
                $('#detailMinor').html(`
                    <div class="minors-list">
                        <h5>Counts Towards Minors:</h5>
                        <div class="minor-buttons">${minorsHtml}</div>
                        <div id="minorPopup" class="minor-popup"></div>
                    </div>
                `);

                // Add click handlers for minor buttons
                $('.minor-button').on('click', function () {
                    const minor = $(this).data('minor');
                    const additionalClasses = getAdditionalClasses(minor);
                    $('#minorPopup').html(`
                        <div class="popup-content">
                            <h6>Additional Required Classes for ${minor}:</h6>
                            ${additionalClasses}
                        </div>
                    `).fadeIn(200);
                });

                // Close popup when clicking outside
                $(document).on('click', function (e) {
                    if (!$(e.target).closest('.minor-button, #minorPopup').length) {
                        $('#minorPopup').fadeOut(200);
                    }
                });

                // Update prerequisite
                $('#detailPrereq').text(item.prereq);
            }
        }

        // Helper function to get additional classes for minors
        function getAdditionalClasses(minor) {
            const additionalClasses = {
                'Computer Science': `
                    <div class="class-status-taken">CS 101 (Taken)</div>
                    <div class="class-status-planned">CS 201 (Planned)</div>
                    <div class="class-status-needed">CS 301 (Need)</div>
                `,
                'Data Science': `
                    <div class="class-status-taken">DS 101 (Taken)</div>
                    <div class="class-status-needed">DS 201 (Need)</div>
                    <div class="class-status-needed">MATH 101 (Need)</div>
                `,
                'Cybersecurity': `
                    <div class="class-status-taken">CS 101 (Taken)</div>
                    <div class="class-status-planned">CS 430 (Planned)</div>
                    <div class="class-status-needed">MATH 101 (Need)</div>
                `
            };
            return additionalClasses[minor] || 'None';
        }

        // Auto-load the first item's details when the modal opens
        $('#myModal').on('shown.bs.modal', function () {
            if (items.length > 0) {
                const firstItem = items[0];
                showElectiveDetails(firstItem.id);
            }
        });

        // Load electives and set up click handlers
        $(document).ready(function () {
            loadItems().then(loadElectives);
            $('#electiveList').on('click', '.list-item', function () {
                const id = $(this).data('id');
                showElectiveDetails(id);
            });
        });
    </script>
</body>
</html>